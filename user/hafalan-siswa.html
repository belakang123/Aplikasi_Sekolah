<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sekolah Digital - Hafalan Anak</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fa;
        }
        .nav-gradient {
            background: linear-gradient(135deg, #001F3F 0%, #009B77 100%);
        }
        .student-card {
            transition: transform 0.3s ease;
        }
        .student-card:hover {
            transform: translateY(-5px);
        }
        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Navigation (Web) -->
    <nav class="nav-gradient text-white hidden md:block">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/8676ecdf-8923-4445-8797-ef1b4bef5883.png" alt="Logo Sekolah Digital" class="w-10 h-10 rounded">
                    <span class="text-xl font-bold">Sekolah Digital</span>
                </div>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="orangtua.html" class="px-3 py-2 hover:bg-white hover:bg-opacity-20 rounded-lg flex items-center">
                        <i class="fas fa-home mr-2"></i>Beranda
                    </a>
                    <a href="jadwal-siswa.html" class="px-3 py-2 hover:bg-white hover:bg-opacity-20 rounded-lg flex items-center">
                        <i class="fas fa-calendar-alt mr-2"></i>Jadwal Anak
                    </a>
                    <a href="absensi-siswa.html" class="px-3 py-2 hover:bg-white hover:bg-opacity-20 rounded-lg flex items-center">
                        <i class="fas fa-user-check mr-2"></i>Absensi Kelas
                    </a>
                    <a href="hafalan-siswa.html" class="px-3 py-2 rounded-lg bg-white bg-opacity-20 flex items-center">
                        <i class="fas fa-book-quran mr-2"></i>Hafalan Anak
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <i class="fas fa-bell text-xl cursor-pointer"></i>
                        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">2</span>
                    </div>
                    <div class="flex items-center space-x-2 cursor-pointer relative" id="profileToggle">
                        <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/1973089b-fe1c-40dd-a6d0-117bffc0113b.png" alt="Foto profil pengguna" class="w-10 h-10 rounded-full border border-gray-300">
                        <div class="flex flex-col">
                            <span class="font-medium text-sm leading-tight">Orang Tua/wali</span>
                        </div>
                        <i class="fas fa-chevron-down text-gray-500 text-lg"></i>

                        <!-- Profile Dropdown Menu -->
                        <div id="profileMenu" class="absolute right-0 top-full mt-2 w-56 bg-white rounded-lg shadow-lg hidden z-10 border border-gray-200">
                            <a href="profil.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors">
                                <i class="fas fa-user mr-2"></i>Profil
                            </a>
                            <a href="#" class="logout-btn block px-4 py-2 text-red-600 hover:bg-red-50 transition-colors">
                                <i class="fas fa-sign-out-alt mr-2"></i>Keluar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Navigation -->
    <div class="md:hidden fixed bottom-0 w-full bg-white shadow-lg z-20">
        <div class="flex justify-around py-3">
            <a href="orangtua.html" class="flex flex-col items-center text-gray-500">
                <i class="fas fa-home text-xl"></i>
                <span class="text-xs mt-1">Beranda</span>
            </a>
            <a href="jadwal-siswa.html" class="flex flex-col items-center text-gray-500">
                <i class="fas fa-calendar-alt text-xl"></i>
                <span class="text-xs mt-1">Jadwal</span>
            </a>
            <a href="absensi-siswa.html" class="flex flex-col items-center text-gray-500">
                <i class="fas fa-user-check text-xl"></i>
                <span class="text-xs mt-1">Absensi</span>
            </a>
            <a href="hafalan-siswa.html" class="flex flex-col items-center text-blue-900">
                <i class="fas fa-book-quran text-xl"></i>
                <span class="text-xs mt-1">Hafalan</span>
            </a>
            <a href="portal-mbl-ortu.html" class="flex flex-col items-center text-gray-500">
                <i class="fas fa-user text-xl"></i>
                <span class="text-xs mt-1">Profil</span>
            </a>
        </div>
    </div>

    <!-- Content -->
    <div class="container mx-auto px-3 sm:px-4 md:px-6 py-4 md:py-8 pb-20 md:pb-6">
        <h2 class="text-xl md:text-2xl font-bold mb-3 md:mb-4 text-blue-900">Hafalan Anak</h2>

        <!-- Class Selector -->
        <div class="mb-6 bg-white p-4 rounded-lg shadow-md">
            <label for="classSelector" class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas:</label>
            <select id="classSelector" class="block w-full md:w-1/3 px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                <!-- Options will be populated by JavaScript -->
            </select>
        </div>

        <!-- Hafalan Table -->
        <section id="hafalan-siswa" class="tab-content bg-white rounded-lg shadow-md p-4 md:p-6">
            <h3 class="text-lg md:text-xl font-semibold mb-4 text-gray-800">Daftar Hafalan Siswa Kelas <span id="selectedClassName" class="text-blue-700"></span></h3>
            
            <div class="overflow-x-auto -mx-3 sm:mx-0">
                <table class="min-w-full bg-white rounded-lg">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-2 px-2 md:py-3 md:px-3 text-left text-gray-700 text-xs md:text-sm">Nama Siswa</th>
                            <th class="py-2 px-2 md:py-3 md:px-3 text-left text-gray-700 text-xs md:text-sm">Total Baru</th>
                            <th class="py-2 px-2 md:py-3 md:px-3 text-left text-gray-700 text-xs md:text-sm">Total Murojaah</th>
                            <th class="py-2 px-2 md:py-3 md:px-3 text-left text-gray-700 text-xs md:text-sm">Tanggal Update Terakhir</th>
                        </tr>
                    </thead>
                    <tbody id="hafalan-table-body" class="divide-y divide-gray-200">
                        <!-- Hafalan rows will be generated here -->
                        <tr><td colspan="4" class="py-4 text-center text-gray-500">Pilih kelas untuk melihat hafalan.</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script type="module">
        import { studentDB, hafalanDB } from '../js/database.js';

        // Global variable to store students data
        let students = []; 
        // Global variable to store the currently selected class
        let selectedClass = '';
        // Global variable to store hafalan data
        let hafalanData = {};

        // Function to load students data from database
        function loadStudentsData() {
            students = studentDB.getAll();
        }

        // Populate class selector dropdown
        function populateClassSelector() {
            const classSelector = document.getElementById('classSelector');
            
            // Get unique classes from all students
            const uniqueClasses = studentDB.getUniqueClasses();

            classSelector.innerHTML = ''; // Clear existing options

            if (uniqueClasses.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Tidak ada kelas terdaftar';
                classSelector.appendChild(option);
                classSelector.disabled = true;
                document.getElementById('selectedClassName').textContent = 'Tidak ada kelas';
                document.getElementById('hafalan-table-body').innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">Tidak ada kelas terdaftar.</td></tr>';
                selectedClass = ''; // Reset selected class
                return;
            }

            classSelector.disabled = false;
            uniqueClasses.forEach(_class => {
                const option = document.createElement('option');
                option.value = _class;
                option.textContent = `Kelas ${_class}`;
                classSelector.appendChild(option);
            });

            // Set the first class as default selected if not already set or if current selected is invalid
            if (!selectedClass || !uniqueClasses.includes(selectedClass)) {
                selectedClass = uniqueClasses[0];
            }
            classSelector.value = selectedClass; // Ensure dropdown reflects the selectedClass

            document.getElementById('selectedClassName').textContent = `Kelas ${selectedClass}`;
            renderHafalanForSelectedClass(); // Render initial hafalan
        }

        // Render Hafalan Table for a specific class
        function renderHafalanForSelectedClass() {
            const tbody = document.getElementById('hafalan-table-body');
            tbody.innerHTML = ''; // Clear previous content
            
            // Filter students by the selected class
            const studentsInClass = students.filter(s => s.class === selectedClass);

            if (!selectedClass || studentsInClass.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">Pilih kelas atau tidak ada siswa di kelas ini.</td></tr>';
                document.getElementById('selectedClassName').textContent = selectedClass ? `Kelas ${selectedClass}` : 'Tidak ada kelas';
                return;
            }

            // Get hafalan data from database
            hafalanData = hafalanDB.load();
            
            studentsInClass.forEach(student => {
                const tr = document.createElement('tr');
                
                const tdName = document.createElement('td');
                tdName.className = 'py-2 px-2 md:py-3 md:px-3 text-sm font-medium text-gray-900';
                tdName.textContent = student.name;
                tr.appendChild(tdName);

                let totalBaru = 0;
                let totalMurojaah = 0;
                let latestUpdateDate = null; // To store the latest date

                // Iterate through all months to sum up 'baru' and 'murojaah' counts
                for (const monthKey in hafalanData) {
                    if (hafalanData.hasOwnProperty(monthKey) && hafalanData[monthKey][student.id]) {
                        const studentMonthlyData = hafalanData[monthKey][student.id];
                        for (const dayKey in studentMonthlyData) {
                            if (studentMonthlyData.hasOwnProperty(dayKey)) {
                                const dailyHafalan = studentMonthlyData[dayKey];
                                
                                // Check if there's any entry for the day
                                if ((dailyHafalan.baru && dailyHafalan.baru.trim() !== '') || (dailyHafalan.murojaah && dailyHafalan.murojaah.trim() !== '')) {
                                    // Update total counts
                                    if (dailyHafalan.baru && dailyHafalan.baru.trim() !== '') {
                                        totalBaru++;
                                    }
                                    if (dailyHafalan.murojaah && dailyHafalan.murojaah.trim() !== '') {
                                        totalMurojaah++;
                                    }

                                    // Determine the date for comparison
                                    const currentYear = new Date().getFullYear(); // Assuming current year for simplicity
                                    const dateString = `${currentYear}-${String(monthKey).padStart(2, '0')}-${String(dayKey).padStart(2, '0')}`;
                                    const currentDate = new Date(dateString);

                                    if (latestUpdateDate === null || currentDate > latestUpdateDate) {
                                        latestUpdateDate = currentDate;
                                    }
                                }
                            }
                        }
                    }
                }

                const tdTotalBaru = document.createElement('td');
                tdTotalBaru.className = 'py-2 px-2 md:py-3 md:px-3 text-sm text-gray-700';
                tdTotalBaru.textContent = totalBaru;
                tr.appendChild(tdTotalBaru);

                const tdTotalMurojaah = document.createElement('td');
                tdTotalMurojaah.className = 'py-2 px-2 md:py-3 md:px-3 text-sm text-gray-700';
                tdTotalMurojaah.textContent = totalMurojaah;
                tr.appendChild(tdTotalMurojaah);

                const tdLatestUpdate = document.createElement('td');
                tdLatestUpdate.className = 'py-2 px-2 md:py-3 md:px-3 text-sm text-gray-700';
                if (latestUpdateDate) {
                    // Format date as DD-MM-YYYY
                    const day = String(latestUpdateDate.getDate()).padStart(2, '0');
                    const month = String(latestUpdateDate.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
                    const year = latestUpdateDate.getFullYear();
                    tdLatestUpdate.textContent = `${day}-${month}-${year}`;
                } else {
                    tdLatestUpdate.textContent = 'Belum Ada';
                }
                tr.appendChild(tdLatestUpdate);

                tbody.appendChild(tr);
            });
        }

        // Initial load and event listeners setup
        document.addEventListener('DOMContentLoaded', () => {
            loadStudentsData(); // Load students data first
            populateClassSelector(); // Then populate selector and render hafalan
            
            // Add event listener for class selector change
            document.getElementById('classSelector').addEventListener('change', (event) => {
                selectedClass = event.target.value;
                document.getElementById('selectedClassName').textContent = `Kelas ${selectedClass}`;
                renderHafalanForSelectedClass();
            });

            // Event listeners for profile dropdown
            const profileToggle = document.getElementById('profileToggle');
            const profileMenu = document.getElementById('profileMenu');

            if (profileToggle && profileMenu) {
                profileToggle.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent click from propagating to document
                    profileMenu.classList.toggle('hidden');
                });

                document.addEventListener('click', (event) => {
                    if (!profileToggle.contains(event.target) && !profileMenu.contains(event.target)) {
                        profileMenu.classList.add('hidden');
                    }
                });
            }
        });

        // Listen for localStorage changes to update data dynamically
        window.addEventListener('storage', (event) => {
            // Only re-render if the 'hafalanApp' or 'studentsApp' key changes
            if (event.key === hafalanDB.key || event.key === studentDB.key) {
                loadStudentsData(); // Re-fetch students data from localStorage
                populateClassSelector(); // Re-populate in case class list changes or students are added/removed
            }
        });
    </script>
</body>
</html>
